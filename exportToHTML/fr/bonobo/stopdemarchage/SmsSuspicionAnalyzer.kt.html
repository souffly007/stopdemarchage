<html>
<head>
<title>SmsSuspicionAnalyzer.kt</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
SmsSuspicionAnalyzer.kt</font>
</center></td></tr></table>
<pre><span class="s0">package </span><span class="s1">fr</span><span class="s2">.</span><span class="s1">bonobo</span><span class="s2">.</span><span class="s1">stopdemarchage</span>

<span class="s1">import android</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">Context</span>
<span class="s1">import android</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">Log</span>
<span class="s1">import org</span><span class="s2">.</span><span class="s1">json</span><span class="s2">.</span><span class="s1">JSONObject</span>
<span class="s1">import org</span><span class="s2">.</span><span class="s1">json</span><span class="s2">.</span><span class="s1">JSONArray</span>
<span class="s1">import java</span><span class="s2">.</span><span class="s1">io</span><span class="s2">.</span><span class="s1">IOException</span>
<span class="s1">import java</span><span class="s2">.</span><span class="s1">text</span><span class="s2">.</span><span class="s1">Normalizer</span>
<span class="s1">import java</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.*</span>
<span class="s1">import kotlin</span><span class="s2">.</span><span class="s1">math</span><span class="s2">.</span><span class="s1">min</span>

<span class="s1">data </span><span class="s0">class </span><span class="s1">SuspicionResult</span><span class="s2">(</span>
    <span class="s0">val </span><span class="s1">score: Int</span><span class="s2">,                    </span><span class="s3">// Score de 0-100%</span>
    <span class="s0">val </span><span class="s1">risk: SuspicionLevel</span><span class="s2">,          </span><span class="s3">// Niveau de risque</span>
    <span class="s0">val </span><span class="s1">detectedWords: List</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;,   </span><span class="s3">// Mots détectés</span>
    <span class="s0">val </span><span class="s1">detectedPatterns: List</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;, </span><span class="s3">// Patterns détectés</span>
    <span class="s0">val </span><span class="s1">explanation: String            </span><span class="s3">// Explication du score</span>
<span class="s2">)</span>

<span class="s1">enum </span><span class="s0">class </span><span class="s1">SuspicionLevel </span><span class="s2">{</span>
    <span class="s1">LOW</span><span class="s2">,      </span><span class="s3">// 0-30%</span>
    <span class="s1">MEDIUM</span><span class="s2">,   </span><span class="s3">// 31-60%</span>
    <span class="s1">HIGH</span><span class="s2">,     </span><span class="s3">// 61-80%</span>
    <span class="s1">CRITICAL  </span><span class="s3">// 81-100%</span>
<span class="s2">}</span>

<span class="s0">class </span><span class="s1">SmsSuspicionAnalyzer</span><span class="s2">(</span>
    <span class="s1">private </span><span class="s0">val </span><span class="s1">context: Context</span><span class="s2">,</span>
    <span class="s1">private </span><span class="s0">val </span><span class="s1">country: String </span><span class="s2">= </span><span class="s4">&quot;FR&quot; </span><span class="s3">// &quot;FR&quot; ou &quot;BE&quot;</span>
<span class="s2">) {</span>

    <span class="s3">// Configuration originale (blocked_words_xx.json)</span>
    <span class="s1">private </span><span class="s0">var </span><span class="s1">blockedWords: Map</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">, </span><span class="s1">List</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;&gt; = </span><span class="s1">emptyMap</span><span class="s2">()</span>
    <span class="s1">private </span><span class="s0">var </span><span class="s1">categoryWeights: Map</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">, </span><span class="s1">Double</span><span class="s2">&gt; = </span><span class="s1">emptyMap</span><span class="s2">()</span>

    <span class="s3">// Nouvelle configuration (spam_detection_config_xx.json)</span>
    <span class="s1">private </span><span class="s0">var </span><span class="s1">highRiskPatterns </span><span class="s2">= </span><span class="s1">mutableListOf</span><span class="s2">&lt;</span><span class="s1">Regex</span><span class="s2">&gt;()</span>
    <span class="s1">private </span><span class="s0">var </span><span class="s1">mediumRiskPatterns </span><span class="s2">= </span><span class="s1">mutableListOf</span><span class="s2">&lt;</span><span class="s1">Regex</span><span class="s2">&gt;()</span>
    <span class="s1">private </span><span class="s0">var </span><span class="s1">highRiskWords </span><span class="s2">= </span><span class="s1">mutableListOf</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;()</span>
    <span class="s1">private </span><span class="s0">var </span><span class="s1">mediumRiskWords </span><span class="s2">= </span><span class="s1">mutableListOf</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;()</span>
    <span class="s1">private </span><span class="s0">var </span><span class="s1">courierScamPatterns </span><span class="s2">= </span><span class="s1">mutableListOf</span><span class="s2">&lt;</span><span class="s1">Regex</span><span class="s2">&gt;()</span>
    <span class="s1">private </span><span class="s0">var </span><span class="s1">suspiciousDomainPatterns </span><span class="s2">= </span><span class="s1">mutableListOf</span><span class="s2">&lt;</span><span class="s1">Regex</span><span class="s2">&gt;()</span>
    <span class="s1">private </span><span class="s0">var </span><span class="s1">suspiciousNumberPatterns </span><span class="s2">= </span><span class="s1">mutableListOf</span><span class="s2">&lt;</span><span class="s1">Regex</span><span class="s2">&gt;()</span>
    <span class="s1">private </span><span class="s0">var </span><span class="s1">trustedSenders </span><span class="s2">= </span><span class="s1">mutableListOf</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;()</span>
    <span class="s1">private </span><span class="s0">var </span><span class="s1">trustedNumbers </span><span class="s2">= </span><span class="s1">mutableListOf</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;()</span>

    <span class="s1">private </span><span class="s0">var </span><span class="s1">config: JSONObject? </span><span class="s2">= </span><span class="s0">null</span>
    <span class="s1">private </span><span class="s0">val </span><span class="s1">TAG </span><span class="s2">= </span><span class="s4">&quot;SmsSuspicionAnalyzer&quot;</span>

    <span class="s1">init </span><span class="s2">{</span>
        <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Initialisation pour le pays: </span><span class="s0">$</span><span class="s1">country</span><span class="s4">&quot;</span><span class="s2">)</span>
        <span class="s1">loadBlockedWords</span><span class="s2">(</span><span class="s1">country</span><span class="s2">)</span>
        <span class="s1">loadSpamDetectionConfig</span><span class="s2">(</span><span class="s1">country</span><span class="s2">)</span>
        <span class="s1">setupWeights</span><span class="s2">()</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">loadBlockedWords</span><span class="s2">(</span><span class="s1">country: String</span><span class="s2">) {</span>
        <span class="s0">try </span><span class="s2">{</span>
            <span class="s0">val </span><span class="s1">fileName </span><span class="s2">= </span><span class="s0">when</span><span class="s2">(</span><span class="s1">country</span><span class="s2">.</span><span class="s1">uppercase</span><span class="s2">()) {</span>
                <span class="s4">&quot;BE&quot; </span><span class="s2">-&gt; </span><span class="s4">&quot;blocked_words_be.json&quot;</span>
                <span class="s0">else </span><span class="s2">-&gt; </span><span class="s4">&quot;blocked_words_fr.json&quot;</span>
            <span class="s2">}</span>

            <span class="s0">val </span><span class="s1">jsonString </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">assets</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">fileName</span><span class="s2">).</span><span class="s1">bufferedReader</span><span class="s2">().</span><span class="s1">use </span><span class="s2">{ </span><span class="s1">it</span><span class="s2">.</span><span class="s1">readText</span><span class="s2">() }</span>
            <span class="s0">val </span><span class="s1">json </span><span class="s2">= </span><span class="s1">JSONObject</span><span class="s2">(</span><span class="s1">jsonString</span><span class="s2">)</span>

            <span class="s3">// Vérifier si la structure existe</span>
            <span class="s0">if </span><span class="s2">(!</span><span class="s1">json</span><span class="s2">.</span><span class="s1">has</span><span class="s2">(</span><span class="s4">&quot;blocked_words&quot;</span><span class="s2">)) {</span>
                <span class="s1">Log</span><span class="s2">.</span><span class="s1">w</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Structure 'blocked_words' non trouvée dans </span><span class="s0">$</span><span class="s1">fileName</span><span class="s4">&quot;</span><span class="s2">)</span>
                <span class="s0">return</span>
            <span class="s2">}</span>

            <span class="s0">val </span><span class="s1">blockedWordsSection </span><span class="s2">= </span><span class="s1">json</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;blocked_words&quot;</span><span class="s2">)</span>

            <span class="s3">// Charger la configuration</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">blockedWordsSection</span><span class="s2">.</span><span class="s1">has</span><span class="s2">(</span><span class="s4">&quot;config&quot;</span><span class="s2">)) {</span>
                <span class="s1">config </span><span class="s2">= </span><span class="s1">blockedWordsSection</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;config&quot;</span><span class="s2">)</span>
                <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Config chargée: </span><span class="s0">${</span><span class="s1">config?</span><span class="s2">.</span><span class="s1">optString</span><span class="s2">(</span><span class="s4">&quot;country&quot;</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s2">}</span>

            <span class="s3">// Charger les catégories</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">blockedWordsSection</span><span class="s2">.</span><span class="s1">has</span><span class="s2">(</span><span class="s4">&quot;categories&quot;</span><span class="s2">)) {</span>
                <span class="s0">val </span><span class="s1">categories </span><span class="s2">= </span><span class="s1">blockedWordsSection</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;categories&quot;</span><span class="s2">)</span>
                <span class="s0">val </span><span class="s1">mutableBlockedWords </span><span class="s2">= </span><span class="s1">mutableMapOf</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">, </span><span class="s1">List</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;&gt;()</span>

                <span class="s0">val </span><span class="s1">categoryNames </span><span class="s2">= </span><span class="s1">categories</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()</span>
                <span class="s0">while </span><span class="s2">(</span><span class="s1">categoryNames</span><span class="s2">.</span><span class="s1">hasNext</span><span class="s2">()) {</span>
                    <span class="s0">val </span><span class="s1">category </span><span class="s2">= </span><span class="s1">categoryNames</span><span class="s2">.</span><span class="s1">next</span><span class="s2">()</span>
                    <span class="s0">val </span><span class="s1">wordsArray </span><span class="s2">= </span><span class="s1">categories</span><span class="s2">.</span><span class="s1">getJSONArray</span><span class="s2">(</span><span class="s1">category</span><span class="s2">)</span>
                    <span class="s0">val </span><span class="s1">wordsList </span><span class="s2">= </span><span class="s1">mutableListOf</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;()</span>
                    <span class="s0">for </span><span class="s2">(</span><span class="s1">i </span><span class="s0">in </span><span class="s5">0 </span><span class="s1">until wordsArray</span><span class="s2">.</span><span class="s1">length</span><span class="s2">()) {</span>
                        <span class="s1">wordsList</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">normalizeText</span><span class="s2">(</span><span class="s1">wordsArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)))</span>
                    <span class="s2">}</span>
                    <span class="s1">mutableBlockedWords</span><span class="s2">[</span><span class="s1">category</span><span class="s2">] = </span><span class="s1">wordsList</span>
                <span class="s2">}</span>

                <span class="s1">blockedWords </span><span class="s2">= </span><span class="s1">mutableBlockedWords</span>
                <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Chargé </span><span class="s0">${</span><span class="s1">blockedWords</span><span class="s2">.</span><span class="s1">size</span><span class="s0">} </span><span class="s4">catégories de mots depuis </span><span class="s0">$</span><span class="s1">fileName</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s2">}</span>

        <span class="s2">} </span><span class="s1">catch </span><span class="s2">(</span><span class="s1">e: IOException</span><span class="s2">) {</span>
            <span class="s1">Log</span><span class="s2">.</span><span class="s1">e</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Fichier blocked_words_</span><span class="s0">$</span><span class="s1">country</span><span class="s4">.json non trouvé&quot;</span><span class="s2">, </span><span class="s1">e</span><span class="s2">)</span>
        <span class="s2">} </span><span class="s1">catch </span><span class="s2">(</span><span class="s1">e: Exception</span><span class="s2">) {</span>
            <span class="s1">Log</span><span class="s2">.</span><span class="s1">e</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Erreur lors du parsing de blocked_words_</span><span class="s0">$</span><span class="s1">country</span><span class="s4">.json&quot;</span><span class="s2">, </span><span class="s1">e</span><span class="s2">)</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">loadSpamDetectionConfig</span><span class="s2">(</span><span class="s1">country: String</span><span class="s2">) {</span>
        <span class="s0">try </span><span class="s2">{</span>
            <span class="s0">val </span><span class="s1">fileName </span><span class="s2">= </span><span class="s0">when</span><span class="s2">(</span><span class="s1">country</span><span class="s2">.</span><span class="s1">uppercase</span><span class="s2">()) {</span>
                <span class="s4">&quot;BE&quot; </span><span class="s2">-&gt; </span><span class="s4">&quot;spam_detection_config_be.json&quot;</span>
                <span class="s0">else </span><span class="s2">-&gt; </span><span class="s4">&quot;spam_detection_config_fr.json&quot;</span>
            <span class="s2">}</span>

            <span class="s0">val </span><span class="s1">jsonString </span><span class="s2">= </span><span class="s1">context</span><span class="s2">.</span><span class="s1">assets</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">fileName</span><span class="s2">).</span><span class="s1">bufferedReader</span><span class="s2">().</span><span class="s1">use </span><span class="s2">{ </span><span class="s1">it</span><span class="s2">.</span><span class="s1">readText</span><span class="s2">() }</span>

            <span class="s3">// Votre structure utilise &quot;config&quot; -&gt; &quot;spam_detection&quot;</span>
            <span class="s0">val </span><span class="s1">rootConfig </span><span class="s2">= </span><span class="s1">JSONObject</span><span class="s2">(</span><span class="s1">jsonString</span><span class="s2">)</span>
            <span class="s0">val </span><span class="s1">spamConfig </span><span class="s2">= </span><span class="s0">if </span><span class="s2">(</span><span class="s1">rootConfig</span><span class="s2">.</span><span class="s1">has</span><span class="s2">(</span><span class="s4">&quot;config&quot;</span><span class="s2">)) {</span>
                <span class="s1">rootConfig</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;config&quot;</span><span class="s2">).</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;spam_detection&quot;</span><span class="s2">)</span>
            <span class="s2">} </span><span class="s0">else if </span><span class="s2">(</span><span class="s1">rootConfig</span><span class="s2">.</span><span class="s1">has</span><span class="s2">(</span><span class="s4">&quot;spam_detection&quot;</span><span class="s2">)) {</span>
                <span class="s1">rootConfig</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;spam_detection&quot;</span><span class="s2">)</span>
            <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
                <span class="s0">throw </span><span class="s1">Exception</span><span class="s2">(</span><span class="s4">&quot;Structure spam_detection non trouvée&quot;</span><span class="s2">)</span>
            <span class="s2">}</span>

            <span class="s1">loadAdvancedPatterns</span><span class="s2">(</span><span class="s1">spamConfig</span><span class="s2">)</span>
            <span class="s1">loadAdvancedWords</span><span class="s2">(</span><span class="s1">spamConfig</span><span class="s2">)</span>
            <span class="s1">loadWhitelist</span><span class="s2">(</span><span class="s1">spamConfig</span><span class="s2">)</span>
            <span class="s1">loadSuspiciousCharacteristics</span><span class="s2">(</span><span class="s1">spamConfig</span><span class="s2">)</span>

            <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Configuration spam avancée chargée avec succès pour </span><span class="s0">$</span><span class="s1">country</span><span class="s4">&quot;</span><span class="s2">)</span>
        <span class="s2">} </span><span class="s1">catch </span><span class="s2">(</span><span class="s1">e: IOException</span><span class="s2">) {</span>
            <span class="s1">Log</span><span class="s2">.</span><span class="s1">w</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;spam_detection_config_</span><span class="s0">$</span><span class="s1">country</span><span class="s4">.json non trouvé, utilisation de la configuration de base uniquement&quot;</span><span class="s2">)</span>
        <span class="s2">} </span><span class="s1">catch </span><span class="s2">(</span><span class="s1">e: Exception</span><span class="s2">) {</span>
            <span class="s1">Log</span><span class="s2">.</span><span class="s1">e</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Erreur lors du chargement de spam_detection_config_</span><span class="s0">$</span><span class="s1">country</span><span class="s4">.json&quot;</span><span class="s2">, </span><span class="s1">e</span><span class="s2">)</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">loadAdvancedPatterns</span><span class="s2">(</span><span class="s1">spamConfig: JSONObject</span><span class="s2">) {</span>
        <span class="s0">try </span><span class="s2">{</span>
            <span class="s0">val </span><span class="s1">patterns </span><span class="s2">= </span><span class="s1">spamConfig</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;patterns&quot;</span><span class="s2">)</span>

            <span class="s3">// Patterns haut risque</span>
            <span class="s0">val </span><span class="s1">highRiskArray </span><span class="s2">= </span><span class="s1">patterns</span><span class="s2">.</span><span class="s1">getJSONArray</span><span class="s2">(</span><span class="s4">&quot;high_risk&quot;</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s2">(</span><span class="s1">i </span><span class="s0">in </span><span class="s5">0 </span><span class="s1">until highRiskArray</span><span class="s2">.</span><span class="s1">length</span><span class="s2">()) {</span>
                <span class="s0">try </span><span class="s2">{</span>
                    <span class="s1">highRiskPatterns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Regex</span><span class="s2">(</span><span class="s1">highRiskArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">RegexOption</span><span class="s2">.</span><span class="s1">IGNORE_CASE</span><span class="s2">))</span>
                <span class="s2">} </span><span class="s1">catch </span><span class="s2">(</span><span class="s1">e: Exception</span><span class="s2">) {</span>
                    <span class="s1">Log</span><span class="s2">.</span><span class="s1">w</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Pattern haut risque invalide: </span><span class="s0">${</span><span class="s1">highRiskArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s3">// Patterns risque moyen</span>
            <span class="s0">val </span><span class="s1">mediumRiskArray </span><span class="s2">= </span><span class="s1">patterns</span><span class="s2">.</span><span class="s1">getJSONArray</span><span class="s2">(</span><span class="s4">&quot;medium_risk&quot;</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s2">(</span><span class="s1">i </span><span class="s0">in </span><span class="s5">0 </span><span class="s1">until mediumRiskArray</span><span class="s2">.</span><span class="s1">length</span><span class="s2">()) {</span>
                <span class="s0">try </span><span class="s2">{</span>
                    <span class="s1">mediumRiskPatterns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Regex</span><span class="s2">(</span><span class="s1">mediumRiskArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">RegexOption</span><span class="s2">.</span><span class="s1">IGNORE_CASE</span><span class="s2">))</span>
                <span class="s2">} </span><span class="s1">catch </span><span class="s2">(</span><span class="s1">e: Exception</span><span class="s2">) {</span>
                    <span class="s1">Log</span><span class="s2">.</span><span class="s1">w</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Pattern risque moyen invalide: </span><span class="s0">${</span><span class="s1">mediumRiskArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Chargé </span><span class="s0">${</span><span class="s1">highRiskPatterns</span><span class="s2">.</span><span class="s1">size</span><span class="s0">} </span><span class="s4">patterns haut risque et </span><span class="s0">${</span><span class="s1">mediumRiskPatterns</span><span class="s2">.</span><span class="s1">size</span><span class="s0">} </span><span class="s4">patterns risque moyen&quot;</span><span class="s2">)</span>
        <span class="s2">} </span><span class="s1">catch </span><span class="s2">(</span><span class="s1">e: Exception</span><span class="s2">) {</span>
            <span class="s1">Log</span><span class="s2">.</span><span class="s1">e</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Erreur lors du chargement des patterns&quot;</span><span class="s2">, </span><span class="s1">e</span><span class="s2">)</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">loadAdvancedWords</span><span class="s2">(</span><span class="s1">spamConfig: JSONObject</span><span class="s2">) {</span>
        <span class="s0">try </span><span class="s2">{</span>
            <span class="s0">val </span><span class="s1">weightedWords </span><span class="s2">= </span><span class="s1">spamConfig</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;weighted_words&quot;</span><span class="s2">)</span>

            <span class="s3">// Mots haut risque</span>
            <span class="s0">val </span><span class="s1">highRisk </span><span class="s2">= </span><span class="s1">weightedWords</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;high_risk&quot;</span><span class="s2">)</span>
            <span class="s0">val </span><span class="s1">highRiskArray </span><span class="s2">= </span><span class="s1">highRisk</span><span class="s2">.</span><span class="s1">getJSONArray</span><span class="s2">(</span><span class="s4">&quot;words&quot;</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s2">(</span><span class="s1">i </span><span class="s0">in </span><span class="s5">0 </span><span class="s1">until highRiskArray</span><span class="s2">.</span><span class="s1">length</span><span class="s2">()) {</span>
                <span class="s1">highRiskWords</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">normalizeText</span><span class="s2">(</span><span class="s1">highRiskArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)))</span>
            <span class="s2">}</span>

            <span class="s3">// Mots risque moyen</span>
            <span class="s0">val </span><span class="s1">mediumRisk </span><span class="s2">= </span><span class="s1">weightedWords</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;medium_risk&quot;</span><span class="s2">)</span>
            <span class="s0">val </span><span class="s1">mediumRiskArray </span><span class="s2">= </span><span class="s1">mediumRisk</span><span class="s2">.</span><span class="s1">getJSONArray</span><span class="s2">(</span><span class="s4">&quot;words&quot;</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s2">(</span><span class="s1">i </span><span class="s0">in </span><span class="s5">0 </span><span class="s1">until mediumRiskArray</span><span class="s2">.</span><span class="s1">length</span><span class="s2">()) {</span>
                <span class="s1">mediumRiskWords</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">normalizeText</span><span class="s2">(</span><span class="s1">mediumRiskArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)))</span>
            <span class="s2">}</span>

            <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Chargé </span><span class="s0">${</span><span class="s1">highRiskWords</span><span class="s2">.</span><span class="s1">size</span><span class="s0">} </span><span class="s4">mots haut risque et </span><span class="s0">${</span><span class="s1">mediumRiskWords</span><span class="s2">.</span><span class="s1">size</span><span class="s0">} </span><span class="s4">mots risque moyen&quot;</span><span class="s2">)</span>
        <span class="s2">} </span><span class="s1">catch </span><span class="s2">(</span><span class="s1">e: Exception</span><span class="s2">) {</span>
            <span class="s1">Log</span><span class="s2">.</span><span class="s1">e</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Erreur lors du chargement des mots pondérés&quot;</span><span class="s2">, </span><span class="s1">e</span><span class="s2">)</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">loadWhitelist</span><span class="s2">(</span><span class="s1">spamConfig: JSONObject</span><span class="s2">) {</span>
        <span class="s0">try </span><span class="s2">{</span>
            <span class="s0">val </span><span class="s1">whitelist </span><span class="s2">= </span><span class="s1">spamConfig</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;whitelist&quot;</span><span class="s2">)</span>

            <span class="s3">// Expéditeurs de confiance</span>
            <span class="s0">val </span><span class="s1">trustedSendersArray </span><span class="s2">= </span><span class="s1">whitelist</span><span class="s2">.</span><span class="s1">getJSONArray</span><span class="s2">(</span><span class="s4">&quot;trusted_senders&quot;</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s2">(</span><span class="s1">i </span><span class="s0">in </span><span class="s5">0 </span><span class="s1">until trustedSendersArray</span><span class="s2">.</span><span class="s1">length</span><span class="s2">()) {</span>
                <span class="s1">trustedSenders</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">normalizeText</span><span class="s2">(</span><span class="s1">trustedSendersArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)))</span>
            <span class="s2">}</span>

            <span class="s3">// Numéros de confiance</span>
            <span class="s0">val </span><span class="s1">trustedNumbersArray </span><span class="s2">= </span><span class="s1">whitelist</span><span class="s2">.</span><span class="s1">getJSONArray</span><span class="s2">(</span><span class="s4">&quot;trusted_numbers&quot;</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s2">(</span><span class="s1">i </span><span class="s0">in </span><span class="s5">0 </span><span class="s1">until trustedNumbersArray</span><span class="s2">.</span><span class="s1">length</span><span class="s2">()) {</span>
                <span class="s1">trustedNumbers</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">trustedNumbersArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">))</span>
            <span class="s2">}</span>

            <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Chargé </span><span class="s0">${</span><span class="s1">trustedSenders</span><span class="s2">.</span><span class="s1">size</span><span class="s0">} </span><span class="s4">expéditeurs de confiance et </span><span class="s0">${</span><span class="s1">trustedNumbers</span><span class="s2">.</span><span class="s1">size</span><span class="s0">} </span><span class="s4">numéros de confiance&quot;</span><span class="s2">)</span>
        <span class="s2">} </span><span class="s1">catch </span><span class="s2">(</span><span class="s1">e: Exception</span><span class="s2">) {</span>
            <span class="s1">Log</span><span class="s2">.</span><span class="s1">e</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Erreur lors du chargement de la liste blanche&quot;</span><span class="s2">, </span><span class="s1">e</span><span class="s2">)</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">loadSuspiciousCharacteristics</span><span class="s2">(</span><span class="s1">spamConfig: JSONObject</span><span class="s2">) {</span>
        <span class="s0">try </span><span class="s2">{</span>
            <span class="s0">val </span><span class="s1">suspicious </span><span class="s2">= </span><span class="s1">spamConfig</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;suspicious_characteristics&quot;</span><span class="s2">)</span>

            <span class="s3">// Patterns de numéros suspects</span>
            <span class="s0">val </span><span class="s1">suspiciousNumbers </span><span class="s2">= </span><span class="s1">suspicious</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;suspicious_numbers&quot;</span><span class="s2">)</span>
            <span class="s0">val </span><span class="s1">numberPatternsArray </span><span class="s2">= </span><span class="s1">suspiciousNumbers</span><span class="s2">.</span><span class="s1">getJSONArray</span><span class="s2">(</span><span class="s4">&quot;patterns&quot;</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s2">(</span><span class="s1">i </span><span class="s0">in </span><span class="s5">0 </span><span class="s1">until numberPatternsArray</span><span class="s2">.</span><span class="s1">length</span><span class="s2">()) {</span>
                <span class="s0">try </span><span class="s2">{</span>
                    <span class="s1">suspiciousNumberPatterns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Regex</span><span class="s2">(</span><span class="s1">numberPatternsArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)))</span>
                <span class="s2">} </span><span class="s1">catch </span><span class="s2">(</span><span class="s1">e: Exception</span><span class="s2">) {</span>
                    <span class="s1">Log</span><span class="s2">.</span><span class="s1">w</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Pattern numéro invalide: </span><span class="s0">${</span><span class="s1">numberPatternsArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s3">// Patterns de domaines suspects</span>
            <span class="s0">val </span><span class="s1">suspiciousDomains </span><span class="s2">= </span><span class="s1">suspicious</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;suspicious_domains&quot;</span><span class="s2">)</span>
            <span class="s0">val </span><span class="s1">domainPatternsArray </span><span class="s2">= </span><span class="s1">suspiciousDomains</span><span class="s2">.</span><span class="s1">getJSONArray</span><span class="s2">(</span><span class="s4">&quot;patterns&quot;</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s2">(</span><span class="s1">i </span><span class="s0">in </span><span class="s5">0 </span><span class="s1">until domainPatternsArray</span><span class="s2">.</span><span class="s1">length</span><span class="s2">()) {</span>
                <span class="s0">try </span><span class="s2">{</span>
                    <span class="s1">suspiciousDomainPatterns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Regex</span><span class="s2">(</span><span class="s1">domainPatternsArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">RegexOption</span><span class="s2">.</span><span class="s1">IGNORE_CASE</span><span class="s2">))</span>
                <span class="s2">} </span><span class="s1">catch </span><span class="s2">(</span><span class="s1">e: Exception</span><span class="s2">) {</span>
                    <span class="s1">Log</span><span class="s2">.</span><span class="s1">w</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Pattern domaine invalide: </span><span class="s0">${</span><span class="s1">domainPatternsArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s3">// Patterns spécifiques aux arnaques coursier</span>
            <span class="s0">val </span><span class="s1">courierScam </span><span class="s2">= </span><span class="s1">suspicious</span><span class="s2">.</span><span class="s1">getJSONObject</span><span class="s2">(</span><span class="s4">&quot;courier_scam_patterns&quot;</span><span class="s2">)</span>
            <span class="s0">val </span><span class="s1">courierPatternsArray </span><span class="s2">= </span><span class="s1">courierScam</span><span class="s2">.</span><span class="s1">getJSONArray</span><span class="s2">(</span><span class="s4">&quot;patterns&quot;</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s2">(</span><span class="s1">i </span><span class="s0">in </span><span class="s5">0 </span><span class="s1">until courierPatternsArray</span><span class="s2">.</span><span class="s1">length</span><span class="s2">()) {</span>
                <span class="s0">try </span><span class="s2">{</span>
                    <span class="s1">courierScamPatterns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Regex</span><span class="s2">(</span><span class="s1">courierPatternsArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">), </span><span class="s1">RegexOption</span><span class="s2">.</span><span class="s1">IGNORE_CASE</span><span class="s2">))</span>
                <span class="s2">} </span><span class="s1">catch </span><span class="s2">(</span><span class="s1">e: Exception</span><span class="s2">) {</span>
                    <span class="s1">Log</span><span class="s2">.</span><span class="s1">w</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Pattern coursier invalide: </span><span class="s0">${</span><span class="s1">courierPatternsArray</span><span class="s2">.</span><span class="s1">getString</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                <span class="s2">}</span>
            <span class="s2">}</span>

            <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Chargé </span><span class="s0">${</span><span class="s1">courierScamPatterns</span><span class="s2">.</span><span class="s1">size</span><span class="s0">} </span><span class="s4">patterns coursier, </span><span class="s0">${</span><span class="s1">suspiciousDomainPatterns</span><span class="s2">.</span><span class="s1">size</span><span class="s0">} </span><span class="s4">domaines suspects&quot;</span><span class="s2">)</span>
        <span class="s2">} </span><span class="s1">catch </span><span class="s2">(</span><span class="s1">e: Exception</span><span class="s2">) {</span>
            <span class="s1">Log</span><span class="s2">.</span><span class="s1">e</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Erreur lors du chargement des caractéristiques suspectes&quot;</span><span class="s2">, </span><span class="s1">e</span><span class="s2">)</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">setupWeights</span><span class="s2">() {</span>
        <span class="s1">categoryWeights </span><span class="s2">= </span><span class="s1">mapOf</span><span class="s2">(</span>
            <span class="s4">&quot;urgency&quot; </span><span class="s1">to </span><span class="s5">3.0</span><span class="s2">,      </span><span class="s3">// Mots d'urgence = très suspect</span>
            <span class="s4">&quot;banking&quot; </span><span class="s1">to </span><span class="s5">2.8</span><span class="s2">,      </span><span class="s3">// Bancaire = très dangereux</span>
            <span class="s4">&quot;phishing&quot; </span><span class="s1">to </span><span class="s5">3.0</span><span class="s2">,     </span><span class="s3">// Liens = très dangereux</span>
            <span class="s4">&quot;technical&quot; </span><span class="s1">to </span><span class="s5">2.5</span><span class="s2">,    </span><span class="s3">// Virus/hack = dangereux</span>
            <span class="s4">&quot;gains&quot; </span><span class="s1">to </span><span class="s5">2.3</span><span class="s2">,        </span><span class="s3">// Gains = suspect</span>
            <span class="s4">&quot;delivery&quot; </span><span class="s1">to </span><span class="s5">1.8</span><span class="s2">,     </span><span class="s3">// Colis = modérément suspect</span>
            <span class="s4">&quot;call&quot; </span><span class="s1">to </span><span class="s5">1.2</span><span class="s2">,         </span><span class="s3">// Appel = peu suspect</span>
            <span class="s4">&quot;government&quot; </span><span class="s1">to </span><span class="s5">2.5    </span><span class="s3">// Gouvernement = dangereux</span>
        <span class="s2">)</span>
    <span class="s2">}</span>

    <span class="s6">/**</span>
     <span class="s6">* Vérifie si l'expéditeur est de confiance</span>
     <span class="s6">*/</span>
    <span class="s1">private </span><span class="s0">fun </span><span class="s1">isFromTrustedSender</span><span class="s2">(</span><span class="s1">phoneNumber: String</span><span class="s2">, </span><span class="s1">message: String</span><span class="s2">)</span><span class="s1">: Boolean </span><span class="s2">{</span>
        <span class="s3">// Vérification des numéros de confiance</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">trustedNumbers</span><span class="s2">.</span><span class="s1">any </span><span class="s2">{ </span><span class="s1">phoneNumber</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s1">it</span><span class="s2">) }) {</span>
            <span class="s0">return true</span>
        <span class="s2">}</span>

        <span class="s3">// Vérification des expéditeurs de confiance dans le message</span>
        <span class="s0">val </span><span class="s1">normalizedMessage </span><span class="s2">= </span><span class="s1">normalizeText</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">trustedSenders</span><span class="s2">.</span><span class="s1">any </span><span class="s2">{ </span><span class="s1">sender </span><span class="s2">-&gt;</span>
            <span class="s1">normalizedMessage</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s1">sender</span><span class="s2">)</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s6">/**</span>
     <span class="s6">* Analyse principale d'un SMS - Version fusionnée</span>
     <span class="s6">*/</span>
    <span class="s0">fun </span><span class="s1">analyzeSms</span><span class="s2">(</span><span class="s1">phoneNumber: String</span><span class="s2">, </span><span class="s1">messageBody: String</span><span class="s2">)</span><span class="s1">: SuspicionResult </span><span class="s2">{</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">messageBody</span><span class="s2">.</span><span class="s1">isBlank</span><span class="s2">()) {</span>
            <span class="s0">return </span><span class="s1">SuspicionResult</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">LOW</span><span class="s2">, </span><span class="s1">emptyList</span><span class="s2">(), </span><span class="s1">emptyList</span><span class="s2">(), </span><span class="s4">&quot;Message vide&quot;</span><span class="s2">)</span>
        <span class="s2">}</span>

        <span class="s3">// Vérification de la liste blanche</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">isFromTrustedSender</span><span class="s2">(</span><span class="s1">phoneNumber</span><span class="s2">, </span><span class="s1">messageBody</span><span class="s2">)) {</span>
            <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Expéditeur de confiance détecté&quot;</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">SuspicionResult</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">LOW</span><span class="s2">, </span><span class="s1">emptyList</span><span class="s2">(), </span><span class="s1">emptyList</span><span class="s2">(), </span><span class="s4">&quot;Expéditeur de confiance&quot;</span><span class="s2">)</span>
        <span class="s2">}</span>

        <span class="s0">val </span><span class="s1">normalizedMessage </span><span class="s2">= </span><span class="s1">normalizeText</span><span class="s2">(</span><span class="s1">messageBody</span><span class="s2">)</span>
        <span class="s0">var </span><span class="s1">totalScore </span><span class="s2">= </span><span class="s5">0.0</span>
        <span class="s0">val </span><span class="s1">detectedWords </span><span class="s2">= </span><span class="s1">mutableListOf</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;()</span>
        <span class="s0">val </span><span class="s1">detectedPatterns </span><span class="s2">= </span><span class="s1">mutableListOf</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;()</span>
        <span class="s0">val </span><span class="s1">explanations </span><span class="s2">= </span><span class="s1">mutableListOf</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;()</span>

        <span class="s3">// 1. Analyse des mots par catégorie (système original)</span>
        <span class="s1">blockedWords</span><span class="s2">.</span><span class="s1">forEach </span><span class="s2">{ (</span><span class="s1">category</span><span class="s2">, </span><span class="s1">words</span><span class="s2">) -&gt;</span>
            <span class="s0">val </span><span class="s1">categoryWords </span><span class="s2">= </span><span class="s1">findWordsInMessage</span><span class="s2">(</span><span class="s1">normalizedMessage</span><span class="s2">, </span><span class="s1">words</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">categoryWords</span><span class="s2">.</span><span class="s1">isNotEmpty</span><span class="s2">()) {</span>
                <span class="s0">val </span><span class="s1">weight </span><span class="s2">= </span><span class="s1">categoryWeights</span><span class="s2">[</span><span class="s1">category</span><span class="s2">] </span><span class="s1">?: </span><span class="s5">1.0</span>
                <span class="s0">val </span><span class="s1">categoryScore </span><span class="s2">= </span><span class="s1">categoryWords</span><span class="s2">.</span><span class="s1">size </span><span class="s2">* </span><span class="s1">weight </span><span class="s2">* </span><span class="s5">8 </span><span class="s3">// Base de 8 points par mot</span>
                <span class="s1">totalScore </span><span class="s2">+= </span><span class="s1">categoryScore</span>

                <span class="s1">detectedWords</span><span class="s2">.</span><span class="s1">addAll</span><span class="s2">(</span><span class="s1">categoryWords</span><span class="s2">)</span>
                <span class="s1">explanations</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s0">$</span><span class="s1">category</span><span class="s4">: </span><span class="s0">${</span><span class="s1">categoryWords</span><span class="s2">.</span><span class="s1">size</span><span class="s0">} </span><span class="s4">mot(s) (+</span><span class="s0">${</span><span class="s1">categoryScore</span><span class="s2">.</span><span class="s1">toInt</span><span class="s2">()</span><span class="s0">}</span><span class="s4">)&quot;</span><span class="s2">)</span>
            <span class="s2">}</span>
        <span class="s2">}</span>

        <span class="s3">// 2. Analyse des nouveaux patterns avancés</span>
        <span class="s0">val </span><span class="s1">advancedPatternScore </span><span class="s2">= </span><span class="s1">analyzeAdvancedPatterns</span><span class="s2">(</span><span class="s1">normalizedMessage</span><span class="s2">, </span><span class="s1">detectedPatterns</span><span class="s2">)</span>
        <span class="s1">totalScore </span><span class="s2">+= </span><span class="s1">advancedPatternScore</span>

        <span class="s3">// 3. Analyse des nouveaux mots pondérés</span>
        <span class="s0">val </span><span class="s1">advancedWordScore </span><span class="s2">= </span><span class="s1">analyzeAdvancedWords</span><span class="s2">(</span><span class="s1">normalizedMessage</span><span class="s2">, </span><span class="s1">detectedWords</span><span class="s2">)</span>
        <span class="s1">totalScore </span><span class="s2">+= </span><span class="s1">advancedWordScore</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">advancedWordScore </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">) {</span>
            <span class="s1">explanations</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;Mots suspects: +</span><span class="s0">${</span><span class="s1">advancedWordScore</span><span class="s2">.</span><span class="s1">toInt</span><span class="s2">()</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
        <span class="s2">}</span>

        <span class="s3">// 4. Analyse des patterns originaux (pour compatibilité)</span>
        <span class="s0">val </span><span class="s1">originalPatternScore </span><span class="s2">= </span><span class="s1">analyzeOriginalPatterns</span><span class="s2">(</span><span class="s1">phoneNumber</span><span class="s2">, </span><span class="s1">normalizedMessage</span><span class="s2">, </span><span class="s1">detectedPatterns</span><span class="s2">)</span>
        <span class="s1">totalScore </span><span class="s2">+= </span><span class="s1">originalPatternScore</span>

        <span class="s3">// 5. Analyse contextuelle améliorée</span>
        <span class="s0">val </span><span class="s1">contextScore </span><span class="s2">= </span><span class="s1">analyzeAdvancedContext</span><span class="s2">(</span><span class="s1">phoneNumber</span><span class="s2">, </span><span class="s1">messageBody</span><span class="s2">, </span><span class="s1">normalizedMessage</span><span class="s2">)</span>
        <span class="s1">totalScore </span><span class="s2">+= </span><span class="s1">contextScore</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">contextScore </span><span class="s2">&gt; </span><span class="s5">0</span><span class="s2">) {</span>
            <span class="s1">explanations</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;Contexte suspect (+</span><span class="s0">${</span><span class="s1">contextScore</span><span class="s2">.</span><span class="s1">toInt</span><span class="s2">()</span><span class="s0">}</span><span class="s4">)&quot;</span><span class="s2">)</span>
        <span class="s2">}</span>

        <span class="s3">// 6. Calcul final du score (max 100)</span>
        <span class="s0">val </span><span class="s1">finalScore </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">totalScore</span><span class="s2">.</span><span class="s1">toInt</span><span class="s2">(), </span><span class="s5">100</span><span class="s2">)</span>
        <span class="s0">val </span><span class="s1">risk </span><span class="s2">= </span><span class="s0">when </span><span class="s2">(</span><span class="s1">finalScore</span><span class="s2">) {</span>
            <span class="s0">in </span><span class="s5">0</span><span class="s2">..</span><span class="s5">30 </span><span class="s2">-&gt; </span><span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">LOW</span>
            <span class="s0">in </span><span class="s5">31</span><span class="s2">..</span><span class="s5">60 </span><span class="s2">-&gt; </span><span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">MEDIUM</span>
            <span class="s0">in </span><span class="s5">61</span><span class="s2">..</span><span class="s5">80 </span><span class="s2">-&gt; </span><span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">HIGH</span>
            <span class="s0">else </span><span class="s2">-&gt; </span><span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">CRITICAL</span>
        <span class="s2">}</span>

        <span class="s0">val </span><span class="s1">explanation </span><span class="s2">= </span><span class="s0">if </span><span class="s2">(</span><span class="s1">explanations</span><span class="s2">.</span><span class="s1">isNotEmpty</span><span class="s2">()) {</span>
            <span class="s1">explanations</span><span class="s2">.</span><span class="s1">joinToString</span><span class="s2">(</span><span class="s4">&quot;, &quot;</span><span class="s2">)</span>
        <span class="s2">} </span><span class="s0">else </span><span class="s2">{</span>
            <span class="s4">&quot;Aucun indicateur suspect détecté&quot;</span>
        <span class="s2">}</span>

        <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Score final: </span><span class="s0">$</span><span class="s1">finalScore</span><span class="s4">, Risque: </span><span class="s0">$</span><span class="s1">risk</span><span class="s4">, Pays: </span><span class="s0">$</span><span class="s1">country</span><span class="s4">&quot;</span><span class="s2">)</span>

        <span class="s0">return </span><span class="s1">SuspicionResult</span><span class="s2">(</span>
            <span class="s1">score </span><span class="s2">= </span><span class="s1">finalScore</span><span class="s2">,</span>
            <span class="s1">risk </span><span class="s2">= </span><span class="s1">risk</span><span class="s2">,</span>
            <span class="s1">detectedWords </span><span class="s2">= </span><span class="s1">detectedWords</span><span class="s2">.</span><span class="s1">distinct</span><span class="s2">(),</span>
            <span class="s1">detectedPatterns </span><span class="s2">= </span><span class="s1">detectedPatterns</span><span class="s2">.</span><span class="s1">distinct</span><span class="s2">(),</span>
            <span class="s1">explanation </span><span class="s2">= </span><span class="s1">explanation</span>
        <span class="s2">)</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">analyzeAdvancedPatterns</span><span class="s2">(</span><span class="s1">message: String</span><span class="s2">, </span><span class="s1">detectedPatterns: MutableList</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;)</span><span class="s1">: Double </span><span class="s2">{</span>
        <span class="s0">var </span><span class="s1">score </span><span class="s2">= </span><span class="s5">0.0</span>

        <span class="s3">// Patterns haut risque (+30 points)</span>
        <span class="s0">for </span><span class="s2">(</span><span class="s1">pattern </span><span class="s0">in </span><span class="s1">highRiskPatterns</span><span class="s2">) {</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">containsMatchIn</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)) {</span>
                <span class="s1">score </span><span class="s2">+= </span><span class="s5">30</span>
                <span class="s1">detectedPatterns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;Haut risque: </span><span class="s0">${</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">take</span><span class="s2">(</span><span class="s5">25</span><span class="s2">)</span><span class="s0">}</span><span class="s4">...&quot;</span><span class="s2">)</span>
                <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Pattern haut risque détecté: </span><span class="s0">${</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">pattern</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s2">}</span>
        <span class="s2">}</span>

        <span class="s3">// Patterns risque moyen (+15 points)</span>
        <span class="s0">for </span><span class="s2">(</span><span class="s1">pattern </span><span class="s0">in </span><span class="s1">mediumRiskPatterns</span><span class="s2">) {</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">containsMatchIn</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)) {</span>
                <span class="s1">score </span><span class="s2">+= </span><span class="s5">15</span>
                <span class="s1">detectedPatterns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;Risque moyen: </span><span class="s0">${</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">take</span><span class="s2">(</span><span class="s5">25</span><span class="s2">)</span><span class="s0">}</span><span class="s4">...&quot;</span><span class="s2">)</span>
                <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Pattern risque moyen détecté: </span><span class="s0">${</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">pattern</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s2">}</span>
        <span class="s2">}</span>

        <span class="s3">// Patterns spécifiques coursier (+35 points car très actuels et dangereux)</span>
        <span class="s0">for </span><span class="s2">(</span><span class="s1">pattern </span><span class="s0">in </span><span class="s1">courierScamPatterns</span><span class="s2">) {</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">containsMatchIn</span><span class="s2">(</span><span class="s1">message</span><span class="s2">)) {</span>
                <span class="s1">score </span><span class="s2">+= </span><span class="s5">35</span>
                <span class="s1">detectedPatterns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;Arnaque coursier: </span><span class="s0">${</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">take</span><span class="s2">(</span><span class="s5">25</span><span class="s2">)</span><span class="s0">}</span><span class="s4">...&quot;</span><span class="s2">)</span>
                <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Pattern arnaque coursier détecté: </span><span class="s0">${</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">pattern</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s2">}</span>
        <span class="s2">}</span>

        <span class="s0">return </span><span class="s1">score</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">analyzeAdvancedWords</span><span class="s2">(</span><span class="s1">message: String</span><span class="s2">, </span><span class="s1">detectedWords: MutableList</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;)</span><span class="s1">: Double </span><span class="s2">{</span>
        <span class="s0">var </span><span class="s1">score </span><span class="s2">= </span><span class="s5">0.0</span>

        <span class="s3">// Mots haut risque (+20 points)</span>
        <span class="s0">for </span><span class="s2">(</span><span class="s1">word </span><span class="s0">in </span><span class="s1">highRiskWords</span><span class="s2">) {</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">message</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s1">word</span><span class="s2">)) {</span>
                <span class="s1">score </span><span class="s2">+= </span><span class="s5">20</span>
                <span class="s1">detectedWords</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s0">$</span><span class="s1">word </span><span class="s4">(+20)&quot;</span><span class="s2">)</span>
                <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Mot haut risque détecté: </span><span class="s0">$</span><span class="s1">word</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s2">}</span>
        <span class="s2">}</span>

        <span class="s3">// Mots risque moyen (+10 points)</span>
        <span class="s0">for </span><span class="s2">(</span><span class="s1">word </span><span class="s0">in </span><span class="s1">mediumRiskWords</span><span class="s2">) {</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">message</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s1">word</span><span class="s2">)) {</span>
                <span class="s1">score </span><span class="s2">+= </span><span class="s5">10</span>
                <span class="s1">detectedWords</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s0">$</span><span class="s1">word </span><span class="s4">(+10)&quot;</span><span class="s2">)</span>
                <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Mot risque moyen détecté: </span><span class="s0">$</span><span class="s1">word</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s2">}</span>
        <span class="s2">}</span>

        <span class="s0">return </span><span class="s1">score</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">analyzeOriginalPatterns</span><span class="s2">(</span><span class="s1">phoneNumber: String</span><span class="s2">, </span><span class="s1">message: String</span><span class="s2">, </span><span class="s1">detectedPatterns: MutableList</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;)</span><span class="s1">: Double </span><span class="s2">{</span>
        <span class="s0">var </span><span class="s1">score </span><span class="s2">= </span><span class="s5">0.0</span>

        <span class="s3">// Pattern 1: Urgence + Lien</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">containsWords</span><span class="s2">(</span><span class="s1">message</span><span class="s2">, </span><span class="s1">listOf</span><span class="s2">(</span><span class="s4">&quot;urgent&quot;</span><span class="s2">, </span><span class="s4">&quot;immediat&quot;</span><span class="s2">, </span><span class="s4">&quot;action&quot;</span><span class="s2">)) &amp;&amp;</span>
            <span class="s1">containsWords</span><span class="s2">(</span><span class="s1">message</span><span class="s2">, </span><span class="s1">listOf</span><span class="s2">(</span><span class="s4">&quot;http&quot;</span><span class="s2">, </span><span class="s4">&quot;www&quot;</span><span class="s2">, </span><span class="s4">&quot;bit.ly&quot;</span><span class="s2">, </span><span class="s4">&quot;lien&quot;</span><span class="s2">))) {</span>
            <span class="s1">score </span><span class="s2">+= </span><span class="s5">25</span>
            <span class="s1">detectedPatterns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;Urgence + Lien&quot;</span><span class="s2">)</span>
        <span class="s2">}</span>

        <span class="s3">// Pattern 2: Argent + Action</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">containsWords</span><span class="s2">(</span><span class="s1">message</span><span class="s2">, </span><span class="s1">listOf</span><span class="s2">(</span><span class="s4">&quot;virement&quot;</span><span class="s2">, </span><span class="s4">&quot;argent&quot;</span><span class="s2">, </span><span class="s4">&quot;gain&quot;</span><span class="s2">, </span><span class="s4">&quot;€&quot;</span><span class="s2">, </span><span class="s4">&quot;euro&quot;</span><span class="s2">)) &amp;&amp;</span>
            <span class="s1">containsWords</span><span class="s2">(</span><span class="s1">message</span><span class="s2">, </span><span class="s1">listOf</span><span class="s2">(</span><span class="s4">&quot;cliquer&quot;</span><span class="s2">, </span><span class="s4">&quot;appeler&quot;</span><span class="s2">, </span><span class="s4">&quot;repondre&quot;</span><span class="s2">))) {</span>
            <span class="s1">score </span><span class="s2">+= </span><span class="s5">20</span>
            <span class="s1">detectedPatterns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;Argent + Action requise&quot;</span><span class="s2">)</span>
        <span class="s2">}</span>

        <span class="s3">// Pattern 3: Fausse entreprise + Problème</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">containsWords</span><span class="s2">(</span><span class="s1">message</span><span class="s2">, </span><span class="s1">listOf</span><span class="s2">(</span><span class="s4">&quot;amazon&quot;</span><span class="s2">, </span><span class="s4">&quot;paypal&quot;</span><span class="s2">, </span><span class="s4">&quot;netflix&quot;</span><span class="s2">, </span><span class="s4">&quot;google&quot;</span><span class="s2">)) &amp;&amp;</span>
            <span class="s1">containsWords</span><span class="s2">(</span><span class="s1">message</span><span class="s2">, </span><span class="s1">listOf</span><span class="s2">(</span><span class="s4">&quot;probleme&quot;</span><span class="s2">, </span><span class="s4">&quot;suspension&quot;</span><span class="s2">, </span><span class="s4">&quot;verification&quot;</span><span class="s2">))) {</span>
            <span class="s1">score </span><span class="s2">+= </span><span class="s5">22</span>
            <span class="s1">detectedPatterns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;Fausse entreprise&quot;</span><span class="s2">)</span>
        <span class="s2">}</span>

        <span class="s3">// Pattern 4: Numéro suspect (amélioré avec les nouveaux patterns)</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">isPhoneNumberSuspiciousAdvanced</span><span class="s2">(</span><span class="s1">phoneNumber</span><span class="s2">)) {</span>
            <span class="s1">score </span><span class="s2">+= </span><span class="s5">15</span>
            <span class="s1">detectedPatterns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;Numéro suspect&quot;</span><span class="s2">)</span>
        <span class="s2">}</span>

        <span class="s3">// Pattern 5: Pression temporelle</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">containsWords</span><span class="s2">(</span><span class="s1">message</span><span class="s2">, </span><span class="s1">listOf</span><span class="s2">(</span><span class="s4">&quot;24h&quot;</span><span class="s2">, </span><span class="s4">&quot;immediat&quot;</span><span class="s2">, </span><span class="s4">&quot;expir&quot;</span><span class="s2">, </span><span class="s4">&quot;dernier&quot;</span><span class="s2">, </span><span class="s4">&quot;echeanc&quot;</span><span class="s2">))) {</span>
            <span class="s1">score </span><span class="s2">+= </span><span class="s5">12</span>
            <span class="s1">detectedPatterns</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;Pression temporelle&quot;</span><span class="s2">)</span>
        <span class="s2">}</span>

        <span class="s0">return </span><span class="s1">score</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">analyzeAdvancedContext</span><span class="s2">(</span><span class="s1">phoneNumber: String</span><span class="s2">, </span><span class="s1">originalMessage: String</span><span class="s2">, </span><span class="s1">normalizedMessage: String</span><span class="s2">)</span><span class="s1">: Double </span><span class="s2">{</span>
        <span class="s0">var </span><span class="s1">score </span><span class="s2">= </span><span class="s5">0.0</span>

        <span class="s3">// Message très court avec lien = suspect</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">originalMessage</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&lt; </span><span class="s5">50 </span><span class="s2">&amp;&amp; </span><span class="s1">containsWords</span><span class="s2">(</span><span class="s1">normalizedMessage</span><span class="s2">, </span><span class="s1">listOf</span><span class="s2">(</span><span class="s4">&quot;http&quot;</span><span class="s2">, </span><span class="s4">&quot;www&quot;</span><span class="s2">, </span><span class="s4">&quot;bit.ly&quot;</span><span class="s2">))) {</span>
            <span class="s1">score </span><span class="s2">+= </span><span class="s5">15</span>
        <span class="s2">}</span>

        <span class="s3">// Trop de liens</span>
        <span class="s0">val </span><span class="s1">linkCount </span><span class="s2">= </span><span class="s1">countLinks</span><span class="s2">(</span><span class="s1">originalMessage</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">linkCount </span><span class="s2">&gt; </span><span class="s5">1</span><span class="s2">) {</span>
            <span class="s1">score </span><span class="s2">+= </span><span class="s1">linkCount </span><span class="s2">* </span><span class="s5">8</span>
        <span class="s2">}</span>

        <span class="s3">// Message en majuscules (agressif)</span>
        <span class="s0">val </span><span class="s1">upperCaseRatio </span><span class="s2">= </span><span class="s1">originalMessage</span><span class="s2">.</span><span class="s1">count </span><span class="s2">{ </span><span class="s1">it</span><span class="s2">.</span><span class="s1">isUpperCase</span><span class="s2">() }.</span><span class="s1">toDouble</span><span class="s2">() / </span><span class="s1">originalMessage</span><span class="s2">.</span><span class="s1">length</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">upperCaseRatio </span><span class="s2">&gt; </span><span class="s5">0.7 </span><span class="s2">&amp;&amp; </span><span class="s1">originalMessage</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">10</span><span class="s2">) {</span>
            <span class="s1">score </span><span class="s2">+= </span><span class="s5">10</span>
        <span class="s2">}</span>

        <span class="s3">// Trop de points d'exclamation (≥ 3)</span>
        <span class="s0">val </span><span class="s1">exclamationCount </span><span class="s2">= </span><span class="s1">originalMessage</span><span class="s2">.</span><span class="s1">count </span><span class="s2">{ </span><span class="s1">it </span><span class="s2">== </span><span class="s4">'!' </span><span class="s2">}</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">exclamationCount </span><span class="s2">&gt;= </span><span class="s5">3</span><span class="s2">) {</span>
            <span class="s1">score </span><span class="s2">+= </span><span class="s5">8</span>
        <span class="s2">}</span>

        <span class="s3">// Domaines suspects</span>
        <span class="s0">for </span><span class="s2">(</span><span class="s1">pattern </span><span class="s0">in </span><span class="s1">suspiciousDomainPatterns</span><span class="s2">) {</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">containsMatchIn</span><span class="s2">(</span><span class="s1">normalizedMessage</span><span class="s2">)) {</span>
                <span class="s1">score </span><span class="s2">+= </span><span class="s5">25</span>
                <span class="s1">Log</span><span class="s2">.</span><span class="s1">d</span><span class="s2">(</span><span class="s1">TAG</span><span class="s2">, </span><span class="s4">&quot;Domaine suspect détecté: </span><span class="s0">${</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">pattern</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>
                <span class="s0">break</span>
            <span class="s2">}</span>
        <span class="s2">}</span>

        <span class="s3">// Fautes d'orthographe typiques</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">containsTypicalMistakes</span><span class="s2">(</span><span class="s1">normalizedMessage</span><span class="s2">)) {</span>
            <span class="s1">score </span><span class="s2">+= </span><span class="s5">8</span>
        <span class="s2">}</span>

        <span class="s0">return </span><span class="s1">score</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">isPhoneNumberSuspiciousAdvanced</span><span class="s2">(</span><span class="s1">phoneNumber: String</span><span class="s2">)</span><span class="s1">: Boolean </span><span class="s2">{</span>
        <span class="s3">// Vérification avec les nouveaux patterns</span>
        <span class="s0">for </span><span class="s2">(</span><span class="s1">pattern </span><span class="s0">in </span><span class="s1">suspiciousNumberPatterns</span><span class="s2">) {</span>
            <span class="s0">if </span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">.</span><span class="s1">matches</span><span class="s2">(</span><span class="s1">phoneNumber</span><span class="s2">)) {</span>
                <span class="s0">return true</span>
            <span class="s2">}</span>
        <span class="s2">}</span>

        <span class="s3">// Vérifications originales</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">phoneNumber</span><span class="s2">.</span><span class="s1">startsWith</span><span class="s2">(</span><span class="s4">&quot;08&quot;</span><span class="s2">) || </span><span class="s1">phoneNumber</span><span class="s2">.</span><span class="s1">startsWith</span><span class="s2">(</span><span class="s4">&quot;09&quot;</span><span class="s2">)) </span><span class="s0">return true</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">phoneNumber</span><span class="s2">.</span><span class="s1">startsWith</span><span class="s2">(</span><span class="s4">&quot;+&quot;</span><span class="s2">) &amp;&amp; !</span><span class="s1">phoneNumber</span><span class="s2">.</span><span class="s1">startsWith</span><span class="s2">(</span><span class="s4">&quot;+33&quot;</span><span class="s2">) &amp;&amp; !</span><span class="s1">phoneNumber</span><span class="s2">.</span><span class="s1">startsWith</span><span class="s2">(</span><span class="s4">&quot;+32&quot;</span><span class="s2">)) </span><span class="s0">return true</span>

        <span class="s0">val </span><span class="s1">cleanNumber </span><span class="s2">= </span><span class="s1">phoneNumber</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">Regex</span><span class="s2">(</span><span class="s4">&quot;[^0-9]&quot;</span><span class="s2">), </span><span class="s4">&quot;&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">cleanNumber</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&lt; </span><span class="s5">8 </span><span class="s2">|| </span><span class="s1">cleanNumber</span><span class="s2">.</span><span class="s1">length </span><span class="s2">&gt; </span><span class="s5">12</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">findWordsInMessage</span><span class="s2">(</span><span class="s1">message: String</span><span class="s2">, </span><span class="s1">words: List</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;)</span><span class="s1">: List</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt; {</span>
        <span class="s0">return </span><span class="s1">words</span><span class="s2">.</span><span class="s1">filter </span><span class="s2">{ </span><span class="s1">word </span><span class="s2">-&gt;</span>
            <span class="s1">message</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s1">word</span><span class="s2">, </span><span class="s1">ignoreCase </span><span class="s2">= </span><span class="s0">true</span><span class="s2">)</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">containsWords</span><span class="s2">(</span><span class="s1">message: String</span><span class="s2">, </span><span class="s1">words: List</span><span class="s2">&lt;</span><span class="s1">String</span><span class="s2">&gt;)</span><span class="s1">: Boolean </span><span class="s2">{</span>
        <span class="s0">return </span><span class="s1">words</span><span class="s2">.</span><span class="s1">any </span><span class="s2">{ </span><span class="s1">word </span><span class="s2">-&gt;</span>
            <span class="s1">message</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s1">word</span><span class="s2">, </span><span class="s1">ignoreCase </span><span class="s2">= </span><span class="s0">true</span><span class="s2">)</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">countLinks</span><span class="s2">(</span><span class="s1">message: String</span><span class="s2">)</span><span class="s1">: Int </span><span class="s2">{</span>
        <span class="s0">val </span><span class="s1">linkPatterns </span><span class="s2">= </span><span class="s1">listOf</span><span class="s2">(</span><span class="s4">&quot;http://&quot;</span><span class="s2">, </span><span class="s4">&quot;https://&quot;</span><span class="s2">, </span><span class="s4">&quot;www.&quot;</span><span class="s2">, </span><span class="s4">&quot;bit.ly&quot;</span><span class="s2">, </span><span class="s4">&quot;tinyurl&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">linkPatterns</span><span class="s2">.</span><span class="s1">sumOf </span><span class="s2">{ </span><span class="s1">pattern </span><span class="s2">-&gt;</span>
            <span class="s1">message</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">).</span><span class="s1">size </span><span class="s2">- </span><span class="s5">1</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">containsTypicalMistakes</span><span class="s2">(</span><span class="s1">message: String</span><span class="s2">)</span><span class="s1">: Boolean </span><span class="s2">{</span>
        <span class="s0">val </span><span class="s1">mistakes </span><span class="s2">= </span><span class="s1">listOf</span><span class="s2">(</span>
            <span class="s4">&quot;votre compte a ete&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;clickez&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;telephonez&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;recu&quot;</span>
        <span class="s2">)</span>

        <span class="s0">return </span><span class="s1">mistakes</span><span class="s2">.</span><span class="s1">any </span><span class="s2">{ </span><span class="s1">wrong </span><span class="s2">-&gt;</span>
            <span class="s1">message</span><span class="s2">.</span><span class="s1">contains</span><span class="s2">(</span><span class="s1">wrong</span><span class="s2">, </span><span class="s1">ignoreCase </span><span class="s2">= </span><span class="s0">true</span><span class="s2">)</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s1">private </span><span class="s0">fun </span><span class="s1">normalizeText</span><span class="s2">(</span><span class="s1">text: String</span><span class="s2">)</span><span class="s1">: String </span><span class="s2">{</span>
        <span class="s0">var </span><span class="s1">normalized </span><span class="s2">= </span><span class="s1">Normalizer</span><span class="s2">.</span><span class="s1">normalize</span><span class="s2">(</span><span class="s1">text</span><span class="s2">, </span><span class="s1">Normalizer</span><span class="s2">.</span><span class="s1">Form</span><span class="s2">.</span><span class="s1">NFD</span><span class="s2">)</span>
            <span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s1">Regex</span><span class="s2">(</span><span class="s4">&quot;[^</span><span class="s0">\\</span><span class="s4">p{ASCII}]&quot;</span><span class="s2">), </span><span class="s4">&quot;&quot;</span><span class="s2">)</span>
            <span class="s2">.</span><span class="s1">lowercase</span><span class="s2">(</span><span class="s1">Locale</span><span class="s2">.</span><span class="s1">getDefault</span><span class="s2">())</span>

        <span class="s3">// Substitution de caractères Unicode suspects (utilisés dans les arnaques)</span>
        <span class="s1">normalized </span><span class="s2">= </span><span class="s1">normalized</span>
            <span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;а&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">) </span><span class="s3">// Cyrillic a</span>
            <span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;е&quot;</span><span class="s2">, </span><span class="s4">&quot;e&quot;</span><span class="s2">) </span><span class="s3">// Cyrillic e</span>
            <span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;о&quot;</span><span class="s2">, </span><span class="s4">&quot;o&quot;</span><span class="s2">) </span><span class="s3">// Cyrillic o</span>
            <span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;р&quot;</span><span class="s2">, </span><span class="s4">&quot;p&quot;</span><span class="s2">) </span><span class="s3">// Cyrillic p</span>
            <span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;с&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">) </span><span class="s3">// Cyrillic c</span>
            <span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;у&quot;</span><span class="s2">, </span><span class="s4">&quot;y&quot;</span><span class="s2">) </span><span class="s3">// Cyrillic y</span>
            <span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;х&quot;</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s2">) </span><span class="s3">// Cyrillic x</span>
            <span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s0">\\</span><span class="s4">s+&quot;</span><span class="s2">.</span><span class="s1">toRegex</span><span class="s2">(), </span><span class="s4">&quot; &quot;</span><span class="s2">) </span><span class="s3">// Normaliser les espaces</span>
            <span class="s2">.</span><span class="s1">trim</span><span class="s2">()</span>

        <span class="s0">return </span><span class="s1">normalized</span>
    <span class="s2">}</span>

    <span class="s6">/**</span>
     <span class="s6">* Méthode utilitaire pour tester un SMS rapidement</span>
     <span class="s6">*/</span>
    <span class="s0">fun </span><span class="s1">isSmsSuspicious</span><span class="s2">(</span><span class="s1">phoneNumber: String</span><span class="s2">, </span><span class="s1">messageBody: String</span><span class="s2">)</span><span class="s1">: Boolean </span><span class="s2">{</span>
        <span class="s0">val </span><span class="s1">result </span><span class="s2">= </span><span class="s1">analyzeSms</span><span class="s2">(</span><span class="s1">phoneNumber</span><span class="s2">, </span><span class="s1">messageBody</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">result</span><span class="s2">.</span><span class="s1">risk </span><span class="s0">in </span><span class="s1">listOf</span><span class="s2">(</span><span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">HIGH</span><span class="s2">, </span><span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">CRITICAL</span><span class="s2">)</span>
    <span class="s2">}</span>

    <span class="s6">/**</span>
     <span class="s6">* Obtenir le niveau de risque sous forme de texte</span>
     <span class="s6">*/</span>
    <span class="s0">fun </span><span class="s1">getRiskText</span><span class="s2">(</span><span class="s1">level: SuspicionLevel</span><span class="s2">)</span><span class="s1">: String </span><span class="s2">{</span>
        <span class="s0">return when </span><span class="s2">(</span><span class="s1">level</span><span class="s2">) {</span>
            <span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">LOW </span><span class="s2">-&gt; </span><span class="s4">&quot;Faible&quot;</span>
            <span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">MEDIUM </span><span class="s2">-&gt; </span><span class="s4">&quot;Modéré&quot;</span>
            <span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">HIGH </span><span class="s2">-&gt; </span><span class="s4">&quot;Élevé&quot;</span>
            <span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">CRITICAL </span><span class="s2">-&gt; </span><span class="s4">&quot;Critique&quot;</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s6">/**</span>
     <span class="s6">* Obtenir la couleur correspondant au niveau de risque</span>
     <span class="s6">*/</span>
    <span class="s0">fun </span><span class="s1">getRiskColor</span><span class="s2">(</span><span class="s1">level: SuspicionLevel</span><span class="s2">)</span><span class="s1">: Int </span><span class="s2">{</span>
        <span class="s0">return when </span><span class="s2">(</span><span class="s1">level</span><span class="s2">) {</span>
            <span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">LOW </span><span class="s2">-&gt; </span><span class="s1">android</span><span class="s2">.</span><span class="s1">R</span><span class="s2">.</span><span class="s1">color</span><span class="s2">.</span><span class="s1">holo_green_light</span>
            <span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">MEDIUM </span><span class="s2">-&gt; </span><span class="s1">android</span><span class="s2">.</span><span class="s1">R</span><span class="s2">.</span><span class="s1">color</span><span class="s2">.</span><span class="s1">holo_orange_light</span>
            <span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">HIGH </span><span class="s2">-&gt; </span><span class="s1">android</span><span class="s2">.</span><span class="s1">R</span><span class="s2">.</span><span class="s1">color</span><span class="s2">.</span><span class="s1">holo_orange_dark</span>
            <span class="s1">SuspicionLevel</span><span class="s2">.</span><span class="s1">CRITICAL </span><span class="s2">-&gt; </span><span class="s1">android</span><span class="s2">.</span><span class="s1">R</span><span class="s2">.</span><span class="s1">color</span><span class="s2">.</span><span class="s1">holo_red_dark</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s6">/**</span>
     <span class="s6">* Obtenir le pays configuré</span>
     <span class="s6">*/</span>
    <span class="s0">fun </span><span class="s1">getCountry</span><span class="s2">()</span><span class="s1">: String </span><span class="s2">{</span>
        <span class="s0">return </span><span class="s1">country</span>
    <span class="s2">}</span>
<span class="s2">}</span></pre>
</body>
</html>